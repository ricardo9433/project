Project 1:SM4 的实现与优化
密码 2 班 董峻豪 钟铭圳       密码1班   张瑞豪
一、算法原理
SM4  是中国国家密码管理局于 2012  年发布的一种分组密码算法，属于对称加密算法， 其分组长度和密钥长度均为 128  位（16   字节）。它采用 Feistel   网络结构，经过 32  轮迭 代加密。
二、核心组件
1、S 盒替换：S  盒是一个固定的 8x8  置换表，用于非线性变换。输入 8   位，输出 8   位， 提供混淆作用。

2 、线性变换：L  函数：用于轮函数中的线性变换。L'  函数：用于密钥扩展中的线性变 换。主要通过循环左移和异或操作实现扩散。

3 、轮函数：每一轮的操作：F (X0,X1,X2,X3,rk) = X0   ⊕ L (T (X1⊕X2⊕X3⊕rk)) 。T   函数 是 S  盒替换和 L  函数的组合。

4 、密钥扩展：从 128  位主密钥生成 32  个 32   位子密钥。使用系统参数 FK   和固定参 数 CK ，每一轮生成一个子密钥。


三、优化原理与实现
1 、预计算 T 盒：T  盒预计算 S   盒替换和 L   函数的组合结果。对于每个可能的 8   位输 入，计算其经过 S  盒替换后再经过 L   函数的结果。只考虑高 8  位的影响，低 24   位为 0， 后续通过移位和异或组合。
4 、查表优化：通过 T  盒直接查表，将多次 S  盒替换和异或操作合并为一次查表，使 用预计算的 T'  盒替代原来的 S  盒替换 + L'   函数。将一个 32  位字分解为 4  个字节，分别 查表。通过移位和异或组合 4  个查表结果，替代原来的多次 S  盒替换和线性变换。
每一轮中：将 X1⊕X2⊕X3⊕rk  分解为 4  个字节。每个字节查表得到部分结果。通过 移位和异或组合 4  个部分结果。与 X0   异或完成一轮运算。
3 、性能优化分析
（1）减少函数调用：每次轮函数需要调用 4  次 S   盒替换和 1   次 L   函数。通过查表 替代，减少了 5  次函数调用
（2）减少循环左移操作：每次轮函数中 L   函数需要 4  次循环左移。预计算时完成部 分循环左移，运行时只需 3  次循环左移
（3）提高缓存利用率：预计算的 T  盒可以更有效地利用 CPU  缓存.查表操作比复杂计 算更适合现代 CPU   的流水线优化。
四、不同分组模式实现
1 、ECB 模式：每个明文块被独立加密为密文块。相同的明文块始终生成相同的密文块。 加密过程：Ci = E (K, Pi) 。解密过程：Pi = D (K, Ci)。
优点：实现简单，并行处理效率高。适合短数据（如密钥加密）
缺点：相同明文生成相同密文，不隐藏数据模式。对密文块的修改不会影响其他块。

2 、CBC 模式：每个明文块先与前一个密文块异或，再进行加密。第一个块使用初始化 向量 (IV) 。加密过程：Ci = E (K, Pi   ⊕ Ci-1) ，C0 = IV 。解密过程：Pi = D (K, Ci)    ⊕ Ci-1。
初始化向量 (IV)：IV  必须是随机的，且长度等于块大小（SM4   中为 16   字节）。IV   不 需要保密，但每次加密必须不同。错误使用 IV（如固定 IV）会导致安全漏洞。
优点：相同明文生成不同密文，隐藏数据模式。密文块的修改会影响后续块的解密。 广 泛应用于各种场景。
缺点：加密无法并行处理（需等待前一个块）。解密可以并行。IV  管理需要额外注意。


3 、填充方式：采用 PKCS#7   填充标准，如果需要填充 n  个字节，则每个填充字节的值 为 n 。例如：需要填充 3  字节，则填充 0x03 0x03 0x03 。去填充时只需读取最后一个字节 的值，然后截取相应长度。

五、实验结果
测试显示，查表优化可带来 30-50%   的性能提升，主要原因：1 、减少函数调用：避免 多次调用 S  盒替换和线性变换函数。2 、减少循环左移操作：预计算时完成部分循环左移。
3 、提高缓存利用率：通过查表替代复杂计算，减少数据依赖
